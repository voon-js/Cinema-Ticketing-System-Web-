@model CinemaTicketingSystem.Models.Booking
@inject CinemaTicketingSystem.Services.IQRService QRService

@{
    ViewData["Title"] = "Booking Confirmation";

    // Pre-calculate seat labels in C# instead of JavaScript
    var seatLabels = new List<string>();
    if (!string.IsNullOrEmpty(Model.SeatNumbers))
    {
        foreach (var seatStr in Model.SeatNumbers.Split(','))
        {
            if (int.TryParse(seatStr, out int seatNumber))
            {
                var row = ((char)('A' + (seatNumber / 10))).ToString();
                var seat = (seatNumber % 10) + 1;
                seatLabels.Add(row + seat);
            }
        }
    }

    // Generate QR code
    var qrCodeData = QRService.GenerateBookingQRCode(
        Model.BookingId,
        Model.Showtime?.Movie?.Title ?? "Movie",
        Model.Showtime?.StartTime ?? DateTime.Now
    );
}

<div class="confirmation-container text-center">
    <div class="confirmation-icon">
        <i class="fas fa-check-circle" style="font-size: 4rem; color: #28a745;"></i>
    </div>

    <h2>Booking Confirmed!</h2>
    <p class="lead">Thank you for your booking. Here are your details:</p>

    <div class="confirmation-details card mx-auto" style="max-width: 500px;">
        <div class="card-body">
            <h5 class="card-title">@Model.Showtime?.Movie?.Title</h5>
            <p><strong>Cinema:</strong> @Model.Showtime?.Cinema?.Name</p>
            <p><strong>Showtime:</strong> @Model.Showtime?.StartTime.ToString("f")</p>
            <p>
                <strong>Seats:</strong>
                @if (seatLabels.Any())
                {
                    <span>@string.Join(", ", seatLabels)</span>
                }
                else
                {
                    <span>@Model.NumberOfTickets tickets (no specific seats)</span>
                }
            </p>
            <p><strong>Total Amount:</strong> @Model.TotalAmount.ToString("C")</p>
            <p><strong>Booking Reference:</strong> #@Model.BookingId</p>

            <!-- QR Code Section -->
            <div class="text-center mt-3">
                <img src="data:image/png;base64,@qrCodeData" alt="Booking QR Code" style="width: 150px; height: 150px;" />
                <p class="text-muted mt-2">Scan this QR code at the cinema</p>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a asp-controller="Booking" asp-action="MyBookings" class="btn btn-primary">View My Bookings</a>
        <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">Back to Home</a>
    </div>
</div>